<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8' />
        <link rel="stylesheet" href="static/dropdown.css" />
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js'></script>
        <script>
            function showtimeToEvent(showtime) {
                var title = showtime["title"];
                if (showtime["format"] != "Standard") {
                    title = `[${showtime["format"]}] ${title}`
                }
                return {
                    "title": title,
                    "start": showtime["start_time"],
                    "end": showtime["end_time"]
                }
            }

            function showtimesToEvents(showtimes) {
                return showtimes.map(showtimeToEvent);
            }


            function baseShowtimeToEventSource(title, events, displayInfo) {
                return {
                    "id": title,
                    "events": events,
                    "backgroundColor": displayInfo[title]["background_color"],
                    "textColor": displayInfo[title]["text_color"]
                }
            }

            function showtimeToEventSource(showtime, displayInfo) {
                return baseShowtimeToEventSource(showtime["title"], [showtimeToEvent(showtime)], displayInfo);
            }

            function showtimesToEventSources(allShowtimes, displayInfo) {
                var showtimesByTitle = Object.groupBy(allShowtimes, (evt) => evt["title"]);
                return Object.entries(showtimesByTitle).map(([title, showtimes]) => {
                    return baseShowtimeToEventSource(title, showtimesToEvents(showtimes), displayInfo);
                });
            }

            async function request(method, path, bodyJson) {
                const url = `/${path}`;
                try {
                    const response = await fetch(url, {method: method, body: JSON.stringify(bodyJson)});
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }

                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error(error.message);
                }
                return {};
            }
            async function get(path) {
                const result = await request("GET", path);
                return result;
            }

            async function put(path, bodyJson) {
                const result = await request("PUT", path, bodyJson);
                return result;
            }

            async function hideMovie(title) {
                const result = put(`movies/${encodeURIComponent(title)}/hide`);
                return result;
            }

            async function showMovie(title) {
                const result = put(`movies/${encodeURIComponent(title)}/show`);
                return result;
            }

            async function getFilteredSchedule(calendar, filterFunc) {
                var theater = selectedTheater();
                var startTime = calendar.formatIso(calendar.view.activeStart);
                var endTime = calendar.formatIso(calendar.view.activeEnd);
                return getSchedule(theater, startTime, endTime)
                    .then(function(result) {
                        var displayInfo = result["display"];
                        return result["showtimes"]
                            .filter(filterFunc)
                            .forEach((showtime) => {
                                var eventSource = calendar.getEventSourceById(showtime["title"]);
                                if (eventSource === null) {
                                    calendar.addEventSource(showtimeToEventSource(showtime, displayInfo));
                                } else {
                                    calendar.addEvent(showtimeToEvent(showtime), eventSource);
                                }
                            });
                    });
            }

            async function getSchedule(theater, startTime, endTime) {
                const result = await get(`showtimes/${encodeURIComponent(theater)}/${startTime}/${endTime}`);
                return result;
            }

            function clearCalendar(calendar) {
                document.getElementById("movie-list").innerHTML = "";
                calendar.getEventSources().forEach((eventSource, i) => eventSource.remove());
            }

            function selectedTheater() {
                var rawTheater = document.getElementById("theater-selected").innerHTML;
                return rawTheater === undefined || rawTheater == null ? "AMC Methuen" : rawTheater;
            }

            document.addEventListener('DOMContentLoaded', function() {
                function loadShowtimesCallback(result) {
                    var allShowtimes = result["showtimes"];
                    var allEvents = showtimesToEvents(allShowtimes);
                    var displayInfo = result["display"];

                    showtimesToEventSources(allShowtimes, displayInfo).forEach((eventSource) => calendar.addEventSource(eventSource));

                    var minStartHour = allEvents.map((e) => new Date(e.start).getHours()).toSorted()[0]
                    if (minStartHour !== undefined) {
                        calendar.setOption('slotMinTime', `${minStartHour}:00:00`);
                    }

                    calendar.render();

                    var movieListEl = document.getElementById("movie-list");
                    movieListEl.innerHTML = "";
                    Object.entries(displayInfo).toSorted().forEach(([title, display], i) => {
                        var entry = document.createElement('div');
                        entry.dataset.title = title;
                        entry.style.border = `thin solid ${display["background_color"]}`;
                        entry.style.borderRadius = "5px";
                        entry.style.margin = "5px";
                        entry.style.padding = "5px";
                        entry.style.cursor = "pointer";
                        if (display["visible"] === true) {
                            entry.style.background = display["background_color"];
                            entry.style.color = display["text_color"];
                        } else {
                            entry.style.background = "white";
                            entry.style.color = display["background_color"];
                        }

                        entry.appendChild(document.createTextNode(title));
                        entry.addEventListener("click", function (e) {
                            var title = e.currentTarget.innerText;
                            var titleShowtimes = calendar.getEvents().filter((evt) => evt.title === title);
                            var titleEventSource = calendar.getEventSourceById(title);
                            var li = movieListEl.querySelector(`[data-title="${title}"]`);
                            if (titleEventSource === null) {
                                entry.style.background = display["background_color"];
                                entry.style.color = display["text_color"];

                                showMovie(title);
                                getFilteredSchedule(calendar, (showtime) => showtime["title"] === title);
                            } else {
                                entry.style.background = "white";
                                entry.style.color = display["background_color"];

                                hideMovie(title);
                                titleEventSource.remove();
                            }
                        });
                        movieListEl.appendChild(entry);
                    });
                };

                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    contentHeight: "auto",
                    nextDayThreshold: '2:00:00',
                    allDaySlot: false,
                    slotMinTime: '09:00:00',
                    fixedWeekCount: false,
                    headerToolbar: {
                        left: 'prev,next',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    datesSet: function(dateInfo) {
                        var endStr = calendar.formatIso(dateInfo.end);
                        var startStr = calendar.formatIso(dateInfo.start);
                        var theater = selectedTheater();

                        clearCalendar(calendar);
                        getSchedule(theater, startStr, endStr).then(loadShowtimesCallback);
                    }
                });
                calendar.render();
                
                document.querySelectorAll("#theater-options .dropdown-item").forEach(item => {
                    item.addEventListener("click", function(e) {
                        var theater = this.textContent.trim();
                        const button = document.getElementById("theater-selected");
                        button.innerHTML = theater;

                        // Visual feedback
                        button.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            button.style.transform = '';
                        }, 300);

                        var startStr = calendar.formatIso(calendar.view.activeStart);
                        var endStr = calendar.formatIso(calendar.view.activeEnd);
                        clearCalendar(calendar);
                        getSchedule(theater, startStr, endStr).then(loadShowtimesCallback);
                    });
                });
                
            });
        </script>
    </head>
    <body>
        <div style="display: flex;">
            <div style="flex: 10%; padding-right: 50px">
                <div class="dropdown" style="margin-top: 20px;">
                    <button id="theater-selected" class="dropdown-toggle">AMC Methuen</button>
                    <div id="theater-options" class="dropdown-menu">
                        <a href="#" class="dropdown-item">AMC Methuen</a>
                        <a href="#" class="dropdown-item">AMC Tyngsboro</a>
                        <a href="#" class="dropdown-item">AMC Boston Common</a>
                        <a href="#" class="dropdown-item">AMC Causeway</a>
                        <a href="#" class="dropdown-item">Apple Hooksett</a>
                        <a href="#" class="dropdown-item">Apple Merrimack</a>
                        <a href="#" class="dropdown-item">Showcase Randolph</a>
                        <a href="#" class="dropdown-item">O'Neil Epping</a>
                        <a href="#" class="dropdown-item">O'Neil Londonderry</a>
                    </div>
                </div>
                <hr />
                <div id="movie-list"></div>
            </div>
            <div style="flex: 90%">
                <div id='calendar'></div>
            </div>
        </div>
    </body>
</html>
