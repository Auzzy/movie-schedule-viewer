<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8' />
        <link rel="stylesheet" href="static/dropdown.css" />
        <link rel="stylesheet" href="static/slider.css" />
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js'></script>
        <script>
            function showtimeToEvent(showtime) {
                var title = showtime["title"];
                if (showtime["format"] != "Standard") {
                    title = `[${showtime["format"]}] ${title}`
                }
                return {
                    "title": title,
                    "start": showtime["start_time"],
                    "end": showtime["end_time"],
                    "extendedProps": {
                        "name": showtime["title"],
                        "theater": showtime["theater"],
                        "format": showtime["format"],
                        "is_open_caption": showtime["is_open_caption"],
                        "no_alist": showtime["no_alist"],
                    }
                }
            }

            function showtimesToEvents(showtimes) {
                return showtimes.map(showtimeToEvent);
            }


            function baseShowtimeToEventSource(title, events, displayInfo) {
                return {
                    "id": title,
                    "events": events,
                    "backgroundColor": displayInfo[title]["background_color"],
                    "textColor": displayInfo[title]["text_color"]
                }
            }

            function showtimeToEventSource(showtime, displayInfo) {
                return baseShowtimeToEventSource(showtime["title"], [showtimeToEvent(showtime)], displayInfo);
            }

            function showtimesToEventSources(showtimes, displayInfo) {
                var showtimesByTitle = Object.groupBy(showtimes, (evt) => evt["title"]);
                return Object.entries(showtimesByTitle).map(([title, showtimes]) => {
                    return baseShowtimeToEventSource(title, showtimesToEvents(showtimes), displayInfo);
                });
            }

            async function request(method, path, bodyJson) {
                const url = `/${path}`;
                try {
                    const response = await fetch(url, {method: method, body: JSON.stringify(bodyJson)});
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }

                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error(error.message);
                }
                return {};
            }
            async function get(path) {
                const result = await request("GET", path);
                return result;
            }

            async function put(path, bodyJson) {
                const result = await request("PUT", path, bodyJson);
                return result;
            }

            async function hideMovie(title) {
                const result = put(`movies/${encodeURIComponent(title)}/hide`);
                return result;
            }

            async function showMovie(title) {
                const result = put(`movies/${encodeURIComponent(title)}/show`);
                return result;
            }

            async function getFilteredSchedule(calendar, filterFunc) {
                var theater = selectedTheater();
                var startTime = calendar.formatIso(calendar.view.activeStart);
                var endTime = calendar.formatIso(calendar.view.activeEnd);
                return getSchedule(theater, startTime, endTime)
                    .then(function(result) {
                        var displayInfo = result["display"];
                        return result["showtimes"]
                            .filter(filterFunc)
                            .forEach((showtime) => {
                                var eventSource = calendar.getEventSourceById(showtime["title"]);
                                if (eventSource === null) {
                                    calendar.addEventSource(showtimeToEventSource(showtime, displayInfo));
                                } else {
                                    calendar.addEvent(showtimeToEvent(showtime), eventSource);
                                }
                            });
                    });
            }

            async function getSchedule(theater, startTime, endTime) {
                const result = await get(`showtimes/${encodeURIComponent(theater)}/${startTime}/${endTime}`);
                return result;
            }

            async function getMovieSchedule(theater, title, startTime, endTime) {
                const result = await get(`showtimes/${encodeURIComponent(theater)}/title/${encodeURIComponent(title)}/${startTime}/${endTime}`);
                return result;
            }

            function resetMovieList() {
                var movieListEl = document.getElementById("movie-list");
                movieListEl.innerHTML = "<div id=\"shown-movies\"></div><div id=\"hidden-movies\"></div>";
            }

            function clearCalendar(calendar) {
                resetMovieList();
                calendar.getEventSources().forEach((eventSource, i) => eventSource.remove());
            }

            function selectedTheater() {
                var rawTheater = document.getElementById("theater-selected").innerHTML;
                return rawTheater === undefined || rawTheater == null ? "AMC Methuen" : rawTheater;
            }

            function toggle_is_checked(toggleEl) {
                if (typeof toggleEl === "string") {
                    toggleEl = document.getElementById(toggleEl);
                }
                return toggleEl.querySelector("label input").checked;
            }

            function createToggleSlider(calendar, id, prop, value) {
                var value = value === undefined ? true : value;
                var toggleEl = document.getElementById(id)
                toggleEl.addEventListener("change", function (e) {
                    if (toggle_is_checked(toggleEl)) {
                        getFilteredSchedule(calendar, (showtime) => showtime[prop] === value);
                    } else {
                        calendar.getEvents().forEach((event) => {
                            if (event.extendedProps[prop] === value) {
                                event.remove();
                            }
                        });
                    }
                });
                return toggleEl;
            }

            function createToggleElement(id, label, initialChecked) {
                var initialChecked = initialChecked === undefined ? true : initialChecked;
                var checkboxEl = Object.assign(document.createElement("input"), {type: "checkbox", checked: initialChecked});
                var sliderEl = Object.assign(document.createElement("span"), {className: "slider round"});
                var switchEl = Object.assign(document.createElement("label"), {className: "switch"});
                switchEl.style.verticalAlign = "middle";
                switchEl.appendChild(checkboxEl);
                switchEl.appendChild(sliderEl);

                var labelEl = Object.assign(document.createElement("label"), {innerHTML: label});
                Object.assign(labelEl.style, {display: "inline-block", verticalAlign: "middle", marginLeft: "4px"});

                var toggleEl = Object.assign(document.createElement("div"), {id: id});
                toggleEl.dataset.label = label;
                toggleEl.style.display = "none";
                toggleEl.appendChild(switchEl);
                toggleEl.appendChild(labelEl);

                return toggleEl;
            }

            function applyShowtimeFilters(showtimes) {
                var negativeFilters = Array.from(document.getElementById("negative-filter-toggles").children)
                    .filter((el) => !toggle_is_checked(el.id))
                    .map((el) => el.dataset.field);
                var enabledFormats = Array.from(document.getElementById("format-filter-toggles").children)
                    .filter((el) => toggle_is_checked(el.id))
                    .map((el) => el.dataset.label);
                return showtimes.filter((showtime) => {
                    return !negativeFilters.some((field) => showtime[field]) && enabledFormats.includes(showtime["format"]);
                });
            }

            function updateNegativeFilters(calendar, showtimes) {
                var negativeFilterTogglesEl = document.getElementById("negative-filter-toggles");
                var negativeFilters = [["Open Captions", "is_open_caption"], ["No A-List", "no_alist"]];
                negativeFilters.forEach(([label, field]) => {
                    var id = `${label.toLowerCase().replace(" ", "-")}-toggle`;
                    var toggleEl = negativeFilterTogglesEl.querySelector(`#${id}`);
                    if (toggleEl === null) {
                        toggleEl = createToggleElement(id, label);
                        toggleEl.dataset.field = field;
                        negativeFilterTogglesEl.appendChild(toggleEl);

                        createToggleSlider(calendar, id, field);
                    }
                    if (showtimes.some((s) => s[field])) {
                        toggleEl.style.removeProperty("display");
                    } else {
                        toggleEl.style.display = "none";
                    }
                });
            }

            function updateFormatFilters(calendar, showtimes) {
                var fmtFilterTogglesEl = document.getElementById("format-filter-toggles");
                var newFormats = Array.from(new Set(showtimes.map((s) => s["format"])));
                var oldFormats = Array.from(fmtFilterTogglesEl.children).map((el) => el.dataset.label);
                var formats = newFormats.concat(oldFormats).toSorted();
                formats.forEach((fmt) => {
                    var id = `${fmt.toLowerCase().replace(" ", "-")}-toggle`;
                    var toggleEl = document.getElementById(id);
                    if (toggleEl === null) {
                        toggleEl = createToggleElement(id, fmt);
                        fmtFilterTogglesEl.appendChild(toggleEl);

                        createToggleSlider(calendar, id, "format", fmt);
                    }
                    if (showtimes.some((s) => s["format"] == fmt)) {
                        toggleEl.style.removeProperty("display");
                    } else {
                        toggleEl.style.display = "none";
                    }
                });
            }

            function updateFilters(calendar, showtimes) {
                updateFormatFilters(calendar, showtimes);
                updateNegativeFilters(calendar, showtimes);
            }

            document.addEventListener('DOMContentLoaded', function() {
                function loadShowtimesCallback(result) {
                    var allShowtimes = result["showtimes"];

                    updateFilters(calendar, allShowtimes);

                    var filteredShowtimes = applyShowtimeFilters(allShowtimes);
                    var displayInfo = result["display"];

                    showtimesToEventSources(filteredShowtimes, displayInfo).forEach((eventSource) => calendar.addEventSource(eventSource));

                    var minStartHour = allShowtimes.map((s) => new Date(s["start_time"]).getHours()).toSorted()[0]
                    if (minStartHour !== undefined) {
                        calendar.setOption('slotMinTime', `${minStartHour}:00:00`);
                    }

                    calendar.render();

                    resetMovieList();
                    var movieListEl = document.getElementById("movie-list");
                    Object.entries(displayInfo).toSorted().forEach(([title, display], i) => {
                        var entry = document.createElement('div');
                        entry.dataset.title = title;
                        entry.style.display = "flex";
                        entry.style.alignItems = "center";
                        entry.style.border = `thin solid ${display["background_color"]}`;
                        entry.style.borderRadius = "5px";
                        entry.style.margin = "5px";
                        entry.style.padding = "5px";
                        entry.style.cursor = "pointer";
                        entry.dataset.visible = display["visible"].toString();
                        if (display["visible"]) {
                            entry.style.background = display["background_color"];
                            entry.style.color = display["text_color"];
                        } else {
                            entry.style.background = "white";
                            entry.style.color = display["background_color"];
                        }

                        entry.addEventListener("click", function (e) {
                            var title = e.currentTarget.dataset.title;
                            var titleShowtimes = calendar.getEvents().filter((evt) => evt.title === title);
                            var titleEventSource = calendar.getEventSourceById(title);
                            var li = movieListEl.querySelector(`[data-title="${title}"]`);
                            if (titleEventSource === null) {
                                entry.style.background = display["background_color"];
                                entry.style.color = display["text_color"];
                                entry.dataset.visible = "true";

                                Array.from(document.getElementById("shown-movies").children)
                                    .find((el) => el.dataset.title > title)
                                    .before(entry);

                                showMovie(title);
                                getFilteredSchedule(calendar, (showtime) => showtime["title"] === title);
                            } else {
                                entry.style.background = "white";
                                entry.style.color = display["background_color"];
                                entry.dataset.visible = "false";

                                Array.from(document.getElementById("hidden-movies").children)
                                    .find((el) => el.dataset.title > title)
                                    .before(entry);

                                hideMovie(title);
                                titleEventSource.remove();
                            }
                        });

                        var titleEl = document.createElement("div");
                        titleEl.innerHTML = title;
                        titleEl.style.flex = "80%";
                        entry.appendChild(titleEl);

                        var openListingEl = document.createElement('button');
                        openListingEl.style.cursor = "pointer";
                        openListingEl.style.backgroundColor = "transparent";
                        openListingEl.style.borderWidth = "1px";
                        openListingEl.innerHTML = "&#x1f4c5";
                        openListingEl.style.maxHeight = "21px";
                        openListingEl.popoverTargetElement = document.getElementById("movie-showtime-listing");
                        openListingEl.addEventListener("click", function(e) {
                            e.stopPropagation();

                            var startStr = calendar.formatIso(calendar.view.activeStart);
                            var endStr = calendar.formatIso(calendar.view.activeEnd);
                            var theater = selectedTheater();
                            var title = e.currentTarget.parentNode.dataset.title;

                            listingCalendar.gotoDate(startStr);
                            getMovieSchedule(theater, title, startStr, endStr).then(function(result) {
                                showtimesToEventSources(result["showtimes"], displayInfo).forEach((eventSource) =>
                                    listingCalendar.addEventSource(eventSource)
                                );
                                listingCalendar.render();
                            });
                        });

                        entry.appendChild(openListingEl);

                        var sublistId = entry.dataset.visible == "true" ? "shown-movies" : "hidden-movies";
                        document.getElementById(sublistId).appendChild(entry);
                    });
                };

                document.getElementById("movie-showtime-listing").addEventListener("beforetoggle", function(e) {
                    if (e.newState === "open") {
                        var listingView = "";
                        switch (calendar.view.type) {
                            case "dayGridMonth": listingView = "listMonth"; break;
                            case "timeGridWeek": listingView = "listWeek"; break;
                            case "timeGridDay": listingView = "listDay"; break;
                            default: throw new Error(`Unrecognized main calendar view type: ${calendar.view.type}`);
                        }

                        var startStr = calendar.formatIso(calendar.view.activeStart);
                        var endStr = calendar.formatIso(calendar.view.activeEnd);
                        listingCalendar.changeView(listingView, {"start": startStr, "end": endStr});
                        listingCalendar.getEventSources().forEach((eventSource, i) => eventSource.remove());
                        listingCalendar.render();
                    }
                });


                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    contentHeight: "auto",
                    nextDayThreshold: '2:00:00',
                    allDaySlot: false,
                    slotMinTime: '09:00:00',
                    fixedWeekCount: false,
                    headerToolbar: {
                        left: 'prev,next',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    datesSet: function(dateInfo) {
                        var endStr = calendar.formatIso(dateInfo.end);
                        var startStr = calendar.formatIso(dateInfo.start);
                        var theater = selectedTheater();

                        clearCalendar(calendar);
                        getSchedule(theater, startStr, endStr).then(loadShowtimesCallback);
                    },
                    eventClick: function(eventClickInfo) {
                        var showtime = eventClickInfo.event;
                        var showtimeDetails = showtime.extendedProps;

                        var startHoursRaw = showtime.start.getHours() % 12;
                        var startHours = startHoursRaw == 0 ? 12 : startHoursRaw;
                        var startMinutes = String(showtime.start.getMinutes()).padStart(2, "0");
                        var startPeriod = showtime.start.getHours() < 12 ? "a" : "p";
                        var startDisplayStr = `${startHours}:${startMinutes}${startPeriod}`;
                        var endHoursRaw = showtime.end.getHours() % 12;
                        var endHours = endHoursRaw == 0 ? 12 : endHoursRaw;
                        var endMinutes = String(showtime.end.getMinutes()).padStart(2, "0");
                        var endPeriod = showtime.end.getHours() < 12 ? "a" : "p";
                        var endDisplayStr = `${endHours}:${endMinutes}${endPeriod}`;

                        var headerEl = document.createElement("h2");
                        headerEl.innerHTML = showtimeDetails["name"];
                        headerEl.style.marginTop = "0px";
                        headerEl.style.marginBottom = "5px";
                        headerEl.style.marginLeft = "0px";

                        var timeEl = document.createElement("div");
                        timeEl.innerHTML = `<i>${startDisplayStr} - ${endDisplayStr}</i>`;

                        var formatStr = showtimeDetails["format"];
                        if (showtimeDetails["is_open_caption"]) {
                            formatStr += ", Open Caption";
                        }
                        if (showtimeDetails["no_alist"]) {
                            formatStr += ", No A-List";
                        }

                        var detailsEl = document.createElement("div");
                        detailsEl.innerHTML = formatStr;

                        var showtimeDetailsPopover = document.getElementById("showtime-details");
                        showtimeDetailsPopover.innerHTML = "";
                        showtimeDetailsPopover.appendChild(headerEl);
                        showtimeDetailsPopover.appendChild(timeEl);
                        showtimeDetailsPopover.appendChild(document.createElement("hr"));
                        showtimeDetailsPopover.appendChild(detailsEl);
                        showtimeDetailsPopover.showPopover();
                    }
                });
                calendar.render();

                var listingCalendarEl = document.getElementById("listing-calendar");
                var listingCalendar = new FullCalendar.Calendar(listingCalendarEl, {
                    initialView: 'listWeek',
                    contentHeight: "auto",
                    allDaySlot: false,
                    headerToolbar: {
                        left: '',
                        center: 'title',
                        right: ''
                    },
                });
                listingCalendar.render();
    
                document.querySelectorAll("#theater-options .dropdown-item").forEach(item => {
                    item.addEventListener("click", function(e) {
                        var theater = this.textContent.trim();
                        const button = document.getElementById("theater-selected");
                        button.innerHTML = theater;

                        // Visual feedback
                        button.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            button.style.transform = '';
                        }, 300);

                        var startStr = calendar.formatIso(calendar.view.activeStart);
                        var endStr = calendar.formatIso(calendar.view.activeEnd);
                        clearCalendar(calendar);
                        getSchedule(theater, startStr, endStr).then(loadShowtimesCallback);
                    });
                });
            });
        </script>
    </head>
    <body>
        <div popover id="showtime-details" style="width: 15%; height: 40%; padding: 10px;"></div>
        <div popover id="movie-showtime-listing" style="width: 25%; height: 65%;">
            <div id='listing-calendar'></div>
        </div>
        <div style="display: flex;">
            <div style="flex: 10%; padding-right: 50px">
                <div class="dropdown" style="margin-top: 20px;">
                    <button id="theater-selected" class="dropdown-toggle">AMC Methuen</button>
                    <div id="theater-options" class="dropdown-menu">
                        <a href="#" class="dropdown-item">AMC Methuen</a>
                        <a href="#" class="dropdown-item">AMC Tyngsboro</a>
                        <a href="#" class="dropdown-item">AMC Boston Common</a>
                        <a href="#" class="dropdown-item">AMC Causeway</a>
                        <a href="#" class="dropdown-item">Apple Hooksett</a>
                        <a href="#" class="dropdown-item">Apple Merrimack</a>
                        <a href="#" class="dropdown-item">Showcase Randolph</a>
                        <a href="#" class="dropdown-item">O'Neil Epping</a>
                        <a href="#" class="dropdown-item">O'Neil Londonderry</a>
                    </div>
                </div>
                <hr />
                <div id="filter-toggles">
                    <div id="negative-filter-toggles"></div>
                    <div id="format-filter-toggles"></div>
                </div>
                <hr />
                <div id="movie-list">
                    <div id="shown-movies"></div>
                    <div id="hidden-movies"></div>
                </div>
            </div>
            <div style="flex: 90%">
                <div id='calendar'></div>
            </div>
        </div>
    </body>
</html>
