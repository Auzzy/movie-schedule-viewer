<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8' />
        <link rel="stylesheet" href="static/dropdown.css" />
        <link rel="stylesheet" href="static/slider.css" />
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js'></script>
        <script>
            function timeStr(date) {
                var hoursRaw = date.getHours() % 12;
                var hours = hoursRaw == 0 ? 12 : hoursRaw;
                var minutes = String(date.getMinutes()).padStart(2, "0");
                var period = date.getHours() < 12 ? "a" : "p";
                return `${hours}:${minutes}${period}`;
            }

            function showtimeToEvent(showtime) {
                var title = showtime["title"];
                if (showtime["format"] != "Standard") {
                    title = `[${showtime["format"]}] ${title}`
                }
                return {
                    "title": title,
                    "start": showtime["start_time"],
                    "end": showtime["end_time"],
                    "extendedProps": {
                        "name": showtime["title"],
                        "theater": showtime["theater"],
                        "format": showtime["format"],
                        "is_open_caption": showtime["is_open_caption"],
                        "no_alist": showtime["no_alist"],
                    }
                }
            }

            function showtimesToEvents(showtimes) {
                return showtimes.map(showtimeToEvent);
            }


            function baseShowtimeToEventSource(title, events, displayInfo) {
                return {
                    "id": title,
                    "events": events,
                    "backgroundColor": displayInfo[title]["background_color"],
                    "textColor": displayInfo[title]["text_color"]
                }
            }

            function showtimeToEventSource(showtime, displayInfo) {
                return baseShowtimeToEventSource(showtime["title"], [showtimeToEvent(showtime)], displayInfo);
            }

            function showtimesToEventSources(showtimes, displayInfo) {
                var showtimesByTitle = Object.groupBy(showtimes, (evt) => evt["title"]);
                return Object.entries(showtimesByTitle).map(([title, showtimes]) => {
                    return baseShowtimeToEventSource(title, showtimesToEvents(showtimes), displayInfo);
                });
            }

            async function request(method, path, bodyJson) {
                const url = `/${path}`;
                try {
                    const response = await fetch(url, {method: method, body: JSON.stringify(bodyJson)});
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }

                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error(error.message);
                }
                return {};
            }
            async function get(path) {
                const result = await request("GET", path);
                return result;
            }

            async function put(path, bodyJson) {
                const result = await request("PUT", path, bodyJson);
                return result;
            }

            async function hideMovie(title) {
                const result = put(`movies/${encodeURIComponent(title)}/hide`);
                return result;
            }

            async function showMovie(title) {
                const result = put(`movies/${encodeURIComponent(title)}/show`);
                return result;
            }

            async function getFilteredSchedule(calendar, filterFunc) {
                var theater = selectedTheater();
                var startTime = calendar.formatIso(calendar.view.activeStart);
                var endTime = calendar.formatIso(calendar.view.activeEnd);
                return getSchedule(theater, startTime, endTime)
                    .then(function(result) {
                        var displayInfo = result["display"];
                        return result["showtimes"]
                            .filter(filterFunc)
                            .forEach((showtime) => {
                                var eventSource = calendar.getEventSourceById(showtime["title"]);
                                if (eventSource === null) {
                                    calendar.addEventSource(showtimeToEventSource(showtime, displayInfo));
                                } else {
                                    calendar.addEvent(showtimeToEvent(showtime), eventSource);
                                }
                            });
                    });
            }

            async function getSchedule(theater, startTime, endTime) {
                const result = await get(`showtimes/${encodeURIComponent(theater)}/${startTime}/${endTime}`);
                return result;
            }

            async function getMovieSchedule(theater, title, startTime, endTime) {
                const result = await get(`showtimes/${encodeURIComponent(theater)}/title/${encodeURIComponent(title)}/${startTime}/${endTime}`);
                return result;
            }

            function resetMovieList() {
                var movieListEl = document.getElementById("movie-list");
                movieListEl.innerHTML = "<div id=\"shown-movies\"></div><div id=\"hidden-movies\"></div>";
            }

            function clearCalendar(calendar) {
                resetMovieList();
                calendar.getEventSources().forEach((eventSource, i) => eventSource.remove());
            }

            function selectedTheater() {
                var rawTheater = document.getElementById("theater-selected").innerHTML;
                return rawTheater === undefined || rawTheater == null ? "AMC Methuen" : rawTheater;
            }

            function toggle_is_checked(toggleEl) {
                if (typeof toggleEl === "string") {
                    toggleEl = document.getElementById(toggleEl);
                }
                return toggleEl.querySelector("label input").checked;
            }

            function createToggleSlider(calendar, id, prop, value) {
                var value = value === undefined ? true : value;
                var toggleEl = document.getElementById(id)
                toggleEl.addEventListener("change", function (e) {
                    if (toggle_is_checked(toggleEl)) {
                        getFilteredSchedule(calendar, (showtime) => showtime[prop] === value);
                    } else {
                        calendar.getEvents().forEach((event) => {
                            if (event.extendedProps[prop] === value) {
                                event.remove();
                            }
                        });
                    }
                });
                return toggleEl;
            }

            function createToggleElement(id, label, initialChecked) {
                var initialChecked = initialChecked === undefined ? true : initialChecked;
                var checkboxEl = Object.assign(document.createElement("input"), {type: "checkbox", checked: initialChecked});
                var sliderEl = Object.assign(document.createElement("span"), {className: "slider round"});
                var switchEl = Object.assign(document.createElement("label"), {className: "switch"});
                switchEl.style.verticalAlign = "middle";
                switchEl.appendChild(checkboxEl);
                switchEl.appendChild(sliderEl);

                var labelEl = Object.assign(document.createElement("label"), {innerHTML: label});
                Object.assign(labelEl.style, {display: "inline-block", verticalAlign: "middle", marginLeft: "4px"});

                var toggleEl = Object.assign(document.createElement("div"), {id: id});
                toggleEl.dataset.label = label;
                toggleEl.style.display = "none";
                toggleEl.appendChild(switchEl);
                toggleEl.appendChild(labelEl);

                return toggleEl;
            }

            function applyShowtimeFilters(showtimes) {
                var negativeFilters = Array.from(document.getElementById("negative-filter-toggles").children)
                    .filter((el) => !toggle_is_checked(el.id))
                    .map((el) => el.dataset.field);
                var enabledFormats = Array.from(document.getElementById("format-filter-toggles").children)
                    .filter((el) => toggle_is_checked(el.id))
                    .map((el) => el.dataset.label);
                return showtimes.filter((showtime) => {
                    return !negativeFilters.some((field) => showtime[field]) && enabledFormats.includes(showtime["format"]);
                });
            }

            function updateNegativeFilters(calendar, showtimes) {
                var negativeFilterTogglesEl = document.getElementById("negative-filter-toggles");
                var negativeFilters = [["Open Captions", "is_open_caption"], ["No A-List", "no_alist"]];
                negativeFilters.forEach(([label, field]) => {
                    var id = `${label.toLowerCase().replace(" ", "-")}-toggle`;
                    var toggleEl = negativeFilterTogglesEl.querySelector(`#${id}`);
                    if (toggleEl === null) {
                        toggleEl = createToggleElement(id, label);
                        toggleEl.dataset.field = field;
                        negativeFilterTogglesEl.appendChild(toggleEl);

                        createToggleSlider(calendar, id, field);
                    }
                    if (showtimes.some((s) => s[field])) {
                        toggleEl.style.removeProperty("display");
                    } else {
                        toggleEl.style.display = "none";
                    }
                });
            }

            function updateFormatFilters(calendar, showtimes) {
                var fmtFilterTogglesEl = document.getElementById("format-filter-toggles");
                var newFormats = Array.from(new Set(showtimes.map((s) => s["format"])));
                var oldFormats = Array.from(fmtFilterTogglesEl.children).map((el) => el.dataset.label);
                var formats = newFormats.concat(oldFormats).toSorted();
                formats.forEach((fmt) => {
                    var id = `${fmt.toLowerCase().replace(" ", "-")}-toggle`;
                    var toggleEl = document.getElementById(id);
                    if (toggleEl === null) {
                        toggleEl = createToggleElement(id, fmt);
                        fmtFilterTogglesEl.appendChild(toggleEl);

                        createToggleSlider(calendar, id, "format", fmt);
                    }
                    if (showtimes.some((s) => s["format"] == fmt)) {
                        toggleEl.style.removeProperty("display");
                    } else {
                        toggleEl.style.display = "none";
                    }
                });
            }

            function updateFilters(calendar, showtimes) {
                updateFormatFilters(calendar, showtimes);
                updateNegativeFilters(calendar, showtimes);
            }

            function openListingClickHandler(event, showtimesCalendar, listingCalendar, displayInfo) {
                event.stopPropagation();

                var startStr = showtimesCalendar.formatIso(showtimesCalendar.view.activeStart);
                var endStr = showtimesCalendar.formatIso(showtimesCalendar.view.activeEnd);
                var theater = selectedTheater();
                var title = event.currentTarget.parentNode.dataset.title;

                listingCalendar.gotoDate(startStr);
                getMovieSchedule(theater, title, startStr, endStr).then(function(result) {
                    showtimesToEventSources(result["showtimes"], displayInfo).forEach((eventSource) =>
                        listingCalendar.addEventSource(eventSource)
                    );

                    listingCalendar.render();
                });
            }

            function createMovieListOpenListingButton(showtimesCalendar, listingCalendar, displayInfo) {
                var openListingEl = document.createElement('button');
                openListingEl.style.cursor = "pointer";
                openListingEl.style.backgroundColor = "transparent";
                openListingEl.style.borderWidth = "1px";
                openListingEl.innerHTML = "&#x1f4c5";
                openListingEl.style.maxHeight = "21px";
                openListingEl.popoverTargetElement = document.getElementById("movie-showtime-listing");
                openListingEl.addEventListener("click", (e) => openListingClickHandler(e, showtimesCalendar, listingCalendar, displayInfo));
                return openListingEl;
            }

            function createMovieListTitleEl(title) {
                var titleEl = document.createElement("div");
                titleEl.innerHTML = title;
                titleEl.style.flex = "80%";
                return titleEl;
            }

            function movieListClickHandler(event, showtimesCalendar, movieListEl, entry, movieDisplayInfo) {
                var title = event.currentTarget.dataset.title;
                var titleShowtimes = showtimesCalendar.getEvents().filter((evt) => evt.title === title);
                var titleEventSource = showtimesCalendar.getEventSourceById(title);
                var li = movieListEl.querySelector(`[data-title="${title}"]`);
                if (titleEventSource === null) {
                    entry.style.background = movieDisplayInfo["background_color"];
                    entry.style.color = movieDisplayInfo["text_color"];
                    entry.dataset.visible = "true";

                    Array.from(document.getElementById("shown-movies").children)
                        .find((el) => el.dataset.title > title)
                        .before(entry);

                    showMovie(title);
                    getFilteredSchedule(showtimesCalendar, (showtime) => showtime["title"] === title);
                } else {
                    entry.style.background = "white";
                    entry.style.color = movieDisplayInfo["background_color"];
                    entry.dataset.visible = "false";

                    Array.from(document.getElementById("hidden-movies").children)
                        .find((el) => el.dataset.title > title)
                        .before(entry);

                    hideMovie(title);
                    titleEventSource.remove();
                }
            }

            function createMovieListItemEl(showtimesCalendar, movieListEl, title, movieDisplayInfo) {
                var entry = document.createElement('div');
                entry.dataset.title = title;
                entry.style.display = "flex";
                entry.style.alignItems = "center";
                entry.style.border = `thin solid ${movieDisplayInfo["background_color"]}`;
                entry.style.borderRadius = "5px";
                entry.style.margin = "5px";
                entry.style.padding = "5px";
                entry.style.cursor = "pointer";
                entry.dataset.visible = movieDisplayInfo["visible"].toString();
                if (movieDisplayInfo["visible"]) {
                    entry.style.background = movieDisplayInfo["background_color"];
                    entry.style.color = movieDisplayInfo["text_color"];
                } else {
                    entry.style.background = "white";
                    entry.style.color = movieDisplayInfo["background_color"];
                }

                entry.addEventListener("click", (e) => movieListClickHandler(e, showtimesCalendar, movieListEl, entry, movieDisplayInfo));
                return entry;
            }

            function createMovieListEntry(showtimesCalendar, listingCalendar, movieListEl, title, displayInfo) {
                var movieDisplayInfo = displayInfo[title];
                var entry = createMovieListItemEl(showtimesCalendar, movieListEl, title, movieDisplayInfo);
                entry.appendChild(createMovieListTitleEl(title));
                entry.appendChild(createMovieListOpenListingButton(showtimesCalendar, listingCalendar, displayInfo));

                var sublistId = entry.dataset.visible == "true" ? "shown-movies" : "hidden-movies";
                document.getElementById(sublistId).appendChild(entry);
            }

            function loadShowtimesCallback(result, showtimesCalendar, listingCalendar) {
                var allShowtimes = result["showtimes"];

                updateFilters(showtimesCalendar, allShowtimes);

                var filteredShowtimes = applyShowtimeFilters(allShowtimes);
                var displayInfo = result["display"];

                showtimesToEventSources(filteredShowtimes, displayInfo).forEach((eventSource) => {
                    showtimesCalendar.addEventSource(eventSource)
                });

                var minStartHour = allShowtimes.map((s) => new Date(s["start_time"]).getHours()).toSorted()[0]
                if (minStartHour !== undefined) {
                    showtimesCalendar.setOption('slotMinTime', `${minStartHour}:00:00`);
                }

                showtimesCalendar.render();

                resetMovieList();
                var movieListEl = document.getElementById("movie-list");
                Object.entries(displayInfo).toSorted().forEach(([title, display], i) => {
                    createMovieListEntry(showtimesCalendar, listingCalendar, movieListEl, title, displayInfo);
                });
            }

            function displayListingCalendar(event, showtimesCalendar, listingCalendar) {
                if (event.newState === "open") {
                    var listingView = "";
                    var titleFormat = false;
                    var listDayFormat = false;
                    switch (showtimesCalendar.view.type) {
                        case "dayGridMonth":
                            listingView = "listMonth";
                            titleFormat = {month: 'long', year: 'numeric'};
                            listDayFormat = {weekday: 'long', month: 'long', day: 'numeric'};
                            break;
                        case "timeGridWeek":
                            listingView = "listWeek";
                            titleFormat = {month: 'long', day: 'numeric', year: 'numeric'};
                            listDayFormat = {weekday: 'long', month: 'long', day: 'numeric'};
                            break;
                        case "timeGridDay":
                            listingView = "listDay";
                            titleFormat = {weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'};
                            break;
                        default: throw new Error(`Unrecognized main calendar view type: ${showtimesCalendar.view.type}`);
                    }

                    listingCalendar.setOption("titleFormat", titleFormat);
                    listingCalendar.setOption("listDayFormat", listDayFormat);

                    var startStr = showtimesCalendar.formatIso(showtimesCalendar.view.activeStart);
                    var endStr = showtimesCalendar.formatIso(showtimesCalendar.view.activeEnd);
                    listingCalendar.changeView(listingView, {"start": startStr, "end": endStr});
                    listingCalendar.getEventSources().forEach((eventSource, i) => eventSource.remove());
                    listingCalendar.render();
                }
            }

            function showtimeClickHandler(eventClickInfo) {
                var showtime = eventClickInfo.event;
                var showtimeDetails = showtime.extendedProps;

                var startDisplayStr = timeStr(showtime.start);
                var endDisplayStr = timeStr(showtime.end);

                var headerEl = document.createElement("h2");
                headerEl.innerHTML = showtimeDetails["name"];
                headerEl.style.margin = "0px 0px 5px 0px";

                var timeEl = document.createElement("div");
                timeEl.innerHTML = `<i>${startDisplayStr} - ${endDisplayStr}</i>`;

                var formatStr = showtimeDetails["format"];
                if (showtimeDetails["is_open_caption"]) {
                    formatStr += ", Open Caption";
                }
                if (showtimeDetails["no_alist"]) {
                    formatStr += ", No A-List";
                }

                var detailsEl = document.createElement("div");
                detailsEl.innerHTML = formatStr;

                var showtimeDetailsPopover = document.getElementById("showtime-details");
                showtimeDetailsPopover.innerHTML = "";
                showtimeDetailsPopover.appendChild(headerEl);
                showtimeDetailsPopover.appendChild(timeEl);
                showtimeDetailsPopover.appendChild(document.createElement("hr"));
                showtimeDetailsPopover.appendChild(detailsEl);
                showtimeDetailsPopover.showPopover();
            }

            function theaterClickHandler(event, showtimesCalendar, listingCalendar) {
                var theater = event.target.textContent.trim();
                const button = document.getElementById("theater-selected");
                button.innerHTML = theater;

                // Visual feedback
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 300);

                var startStr = showtimesCalendar.formatIso(showtimesCalendar.view.activeStart);
                var endStr = showtimesCalendar.formatIso(showtimesCalendar.view.activeEnd);
                clearCalendar(showtimesCalendar);
                getSchedule(theater, startStr, endStr).then((result) => {
                    loadShowtimesCallback(result, showtimesCalendar, listingCalendar)
                });
            }

            document.addEventListener('DOMContentLoaded', function() {
                var showtimesCalendarEl = document.getElementById('showtimes-calendar');
                var showtimesCalendar = new FullCalendar.Calendar(showtimesCalendarEl, {
                    initialView: 'dayGridMonth',
                    contentHeight: "auto",
                    nextDayThreshold: '2:00:00',
                    allDaySlot: false,
                    slotMinTime: '09:00:00',
                    fixedWeekCount: false,
                    headerToolbar: {
                        left: 'prev,next',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    datesSet: (dateInfo) => {
                        var endStr = showtimesCalendar.formatIso(dateInfo.end);
                        var startStr = showtimesCalendar.formatIso(dateInfo.start);
                        var theater = selectedTheater();

                        clearCalendar(showtimesCalendar);
                        getSchedule(theater, startStr, endStr).then((result) => {
                            loadShowtimesCallback(result, showtimesCalendar, listingCalendar)
                        });
                    },
                    eventClick: showtimeClickHandler
                });
                showtimesCalendar.render();

                var listingCalendarEl = document.getElementById("listing-calendar");
                var listingCalendar = new FullCalendar.Calendar(listingCalendarEl, {
                    initialView: 'listWeek',
                    contentHeight: "auto",
                    allDaySlot: false,
                    headerToolbar: {
                        left: '',
                        center: 'title',
                        right: ''
                    },
                    listDayFormat: {weekday: 'long', month: 'long', day: 'numeric'},
                    listDaySideFormat: false
                });
                listingCalendar.render();

                document.getElementById("movie-showtime-listing").addEventListener("beforetoggle", (event) => {
                    displayListingCalendar(event, showtimesCalendar, listingCalendar);
                });

                document.querySelectorAll("#theater-options .dropdown-item").forEach(item => {
                    item.addEventListener("click", (e) => {
                        theaterClickHandler(e, showtimesCalendar, listingCalendar);
                    });
                });
            });
        </script>
    </head>
    <body>
        <div popover id="showtime-details" style="width: 15%; height: 40%; padding: 10px;"></div>
        <div popover id="movie-showtime-listing" style="width: 25%; height: 65%;">
            <div id='listing-calendar'></div>
        </div>
        <div style="display: flex;">
            <div style="flex: 10%; padding-right: 50px">
                <div class="dropdown" style="margin-top: 20px;">
                    <button id="theater-selected" class="dropdown-toggle">AMC Methuen</button>
                    <div id="theater-options" class="dropdown-menu">
                        <a href="#" class="dropdown-item">AMC Methuen</a>
                        <a href="#" class="dropdown-item">AMC Tyngsboro</a>
                        <a href="#" class="dropdown-item">AMC Boston Common</a>
                        <a href="#" class="dropdown-item">AMC Causeway</a>
                        <a href="#" class="dropdown-item">Apple Hooksett</a>
                        <a href="#" class="dropdown-item">Apple Merrimack</a>
                        <a href="#" class="dropdown-item">Showcase Randolph</a>
                        <a href="#" class="dropdown-item">O'Neil Epping</a>
                        <a href="#" class="dropdown-item">O'Neil Londonderry</a>
                    </div>
                </div>
                <hr />
                <div id="filter-toggles">
                    <div id="negative-filter-toggles"></div>
                    <div id="format-filter-toggles"></div>
                </div>
                <hr />
                <div id="movie-list">
                    <div id="shown-movies"></div>
                    <div id="hidden-movies"></div>
                </div>
            </div>
            <div style="flex: 90%">
                <div id='showtimes-calendar'></div>
            </div>
        </div>
    </body>
</html>
